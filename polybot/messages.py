"""–í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–æ—Ç–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –æ–±—â–µ–º –¥–æ—Å—Ç—É–ø–µ.

–†–∞–∑–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º.
"""

from datetime import datetime

from maupoly import exceptions
from maupoly.field import BaseField, BaseRentField, FieldType
from maupoly.game import MonoGame

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# =====================

# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ /help
HELP_MESSAGE = (
    "üç∞ <b>–¢—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</b>:\n"
    "1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É.\n"
    "2. –í –≥—Ä—É–ø–ø–µ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É —á–µ—Ä–µ–∑ /game –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ /join.\n"
    "3. –ï—Å–ª–∏ –≤–∞—Å –¥–≤–æ–µ –∏ –±–æ–ª—å—à–µ, –Ω–∞—á–∏–Ω–∞–π—Ç–µ –∏–≥—Ä—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ /start!\n\n"
    "–ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.\n"
    "–ß—Ç–æ–±—ã –ø–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /leave.\n"
    "–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–æ–ª–≥–æ –¥—É–º–∞–µ—Ç. –µ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /skip.\n"
    "‚òï –û –ø—Ä–æ—á–∏—Ö –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ <b>–º–µ–Ω—é</b>.\n"
)

# –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
NO_ROOM_MESSAGE = (
    "üëÄ –í –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –µ—â—ë <b>–Ω–µ—Ç –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã</b>.\n"
    "üç∞ –í—ã –º–æ–∂–µ—Ç–µ <b>—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é</b> –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã /game."
)

NO_JOIN_MESSAGE = (
    "üçì –î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–¥–æ <b>–∑–∞–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</b>.\n"
    "üç∞ –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π /join.\n"
    "üîë –ï—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b> –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã."
)

# –ö–æ–≥–¥–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã
NOT_ENOUGH_PLAYERS = (
    "üå≥ <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤</b> (–º–∏–Ω–∏–º—É–º 2) –¥–ª—è –∏–≥—Ä—ã.\n"
    "–ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â—ë <b>–Ω–µ –Ω–∞—á–∞–ª–∞—Å—å</b> –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π "
    "/join —á—Ç–æ–±—ã –∑–∞–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É.\n"
    "üç∞ –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ /game."
)


def get_closed_room_message(game: MonoGame) -> str:
    """–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∑–∞–∫—Ä—ã—Ç—É—é –∫–æ–º–Ω–∞—Ç—É."""
    return (
        "üîí –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –¥–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b>.\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å {game.owner.name} –æ—Ç–∫—Ä—ã—Ç—å"
        "–∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä–∞."
    )


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# =======================


def plural_form(n: int, v: tuple[str, str, str]) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∏—Å–ª–∞.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–ª–æ–Ω—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: "–¥–ª—è –æ–¥–Ω–æ–≥–æ", "–¥–ª—è –¥–≤—É—Ö",
    "–¥–ª—è –ø—è—Ç–∏" –∑–Ω–∞—á–µ–Ω–∏–π.
    """
    return v[2 if (4 < n % 100 < 20) else (2, 0, 1, 1, 1, 2)[min(n % 10, 5)]]  # noqa: PLR2004


def get_str_timedelta(seconds: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ–∫—É–Ω–¥."""
    m, s = divmod(seconds, 60)
    if m == 0:
        return f"{s} {plural_form(m, ('—Å–µ–∫—É–Ω–¥—É', '—Å–µ–∫—É–Ω–¥—ã', '—Å–µ–∫—É–Ω–¥'))}"
    if s == 0:
        return f"{m} {plural_form(m, ('–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'))}"
    return (
        f"{m} {plural_form(m, ('–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'))} –∏ "
        f"{s} {plural_form(m, ('—Å–µ–∫—É–Ω–¥—É', '—Å–µ–∫—É–Ω–¥—ã', '—Å–µ–∫—É–Ω–¥'))}"
    )


# –ö–æ–º–Ω–∞—Ç–∞
# =======


def get_all_room_players(game: MonoGame) -> str:
    """–°–æ–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ä—Ç –∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞."""
    if len(game.players) == 0:
        return "‚ú® –í –∫–æ–º–Ω–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç—É.\n"
    players_list = f"‚ú® –≤—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ {len(game.players)}:\n"
    for player in game.players:
        players_list += f"- {player.name}\n"
    return players_list


def get_room_players(game: MonoGame) -> str:
    """–°–æ–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã."""
    players_list = f"‚ú® –ò–≥—Ä–æ–∫–∏ ({len(game.players)}):\n"
    for i, player in enumerate(game.players):
        if i == game.current_player:
            players_list += f"- <b>{player.name}</b>\n"
        else:
            players_list += f"- {player.name}\n"
    return players_list


def get_new_game_message(game: MonoGame) -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã –≤ –∫–æ–º–Ω–∞—Ç–µ.

    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ç–æ –ø–µ—Ä–≤—ã–º —Ö–æ–¥–∏—Ç, –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    —Ä–µ–∂–∏–º—ã –∏–≥—Ä—ã.
    """
    return (
        "üå≥ –î–∞ –Ω–∞—á–Ω—ë—Ç—Å—è <b>–ù–æ–≤–∞—è –∏–≥—Ä–∞!</b>!\n"
        f"‚ú® –ò –ø–µ—Ä–≤—ã–º —É –Ω–∞—Å —Ö–æ–¥–∏—Ç {game.player.name}\n"
        "/rules —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–≥—Ä–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞.\n"
        "/close —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É –æ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö.\n\n"
        f"{get_all_room_players(game)}\n"
        # f"{get_room_rules(game)}"
    )


def get_room_status(game: MonoGame) -> str:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã."""
    if not game.started:
        return (
            f"‚òï –ù–æ–≤–∞—è <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b>!\n"
            f"<b>–°–æ–∑–¥–∞–ª</b>: {game.owner.name}\n\n"
            f"{get_all_room_players(game)}\n"
            "‚öôÔ∏è <b>–ø—Ä–∞–≤–∏–ª–∞</b> –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–¥–µ–ª–∞—Ç—å –∏–≥—Ä—É –±–æ–ª–µ–µ –≤–µ—Å—ë–ª–æ–π.\n"
            "- /rules –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –∫–æ–º–Ω–∞—Ç—ã\n"
            "- /join —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ ‚ú®\n"
            "- /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–µ—Å–µ–ª—å—è!üç∞"
        )

    now = datetime.now()
    game_delta = get_str_timedelta(int((now - game.game_start).total_seconds()))
    turn_delta = get_str_timedelta(int((now - game.turn_start).total_seconds()))
    return (
        f"‚òï <b>–ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</b> {game.owner.name}:\n"
        f"ü¶ù <b>–°–µ–π—á–∞—Å —Ö–æ–¥</b> {game.player.name} "
        f"(–ø—Ä–æ—à–ª–æ {turn_delta})\n\n"
        f"{get_room_players(game)}\n"
        # f"{get_room_rules(game)}\n"
        f"‚è≥ <b>–ò–≥—Ä–∞ –¥–ª–∏—Ç—Å—è</b> {game_delta}\n"
    )


def get_error_message(exc: Exception) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ."""
    if isinstance(exc, exceptions.NoGameInChatError):
        return NO_ROOM_MESSAGE

    if isinstance(exc, exceptions.LobbyClosedError):
        return (
            "üîí –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –¥–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ <b>–∑–∞–∫—Ä—ã—Ç–∞</b>.\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–æ–º–Ω–∞—Ç—ã –æ—Ç–∫—Ä—ã—Ç—å"
            "–∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä–∞."
        )

    if isinstance(exc, exceptions.NotEnoughPlayersError):
        return NOT_ENOUGH_PLAYERS

    return f"üëÄ –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É...\n\n{exc}"


def end_game_message(game: MonoGame) -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã.

    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã –∏ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö.
    –ù—É –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, –µ—Å–ª–∏ –±—É–¥–µ—Ç –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É.
    """
    if game.winner is None:
        res = "‚ú® <b>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</b>!\nüëë –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –Ω–µ—Ç\n"
    else:
        res = f"‚ú® <b>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</b>!\nüëë –ú–æ–Ω–æ–ø–æ–ª–∏—Å—Ç: {game.winner.name}\n"
    res += "\nü™ô –ë–∞–Ω–∫—Ä–æ—Ç—ã:\n"
    for i, loser in enumerate(game.bankrupts):
        res += f"{i + 1}. {loser.name}\n"

    res += "\nüç∞ /game - —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É!"
    return res


# –û–ø–∏—Å–∞–Ω–∏–µ —è—á–µ–µ–∫
# =============


def field_status(field: BaseField | BaseRentField) -> str:
    """–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–µ."""
    res = f"{field.type.symbol}<b>{field.name}</b>"
    if isinstance(field, BaseRentField):
        if field.owner is not None:
            res += f" {field.owner.name} {field.count_rent()}üí∏"
        else:
            res += f" —Ü–µ–Ω–∞ {field.buy_cost}üí∏"
    return res
